# Daily Report — 13.11.2025

## Scope
- Hoàn tất module Rewards & Donate Sprint 3 (DB + API + UI) theo yêu cầu AGENTS.
- Gắn Vitality Points với Mission Lite và phát sinh sự kiện Dia Brain `donate`.
- Bổ sung tài liệu/env/test để QA có thể bật cờ và smoke ngay.

## Worklog
1. Tạo migration `117_reward_wallet.sql`: bảng `vp_ledger`, `vp_balances`, `donation_log`, seed 3 catalog item + ladder mặc định; bật RLS + index để đọc nhanh.
2. Thêm `src/modules/rewards/ledger.ts` (credit/debit idempotent, balance cache) và gọi credit ngay trong `missionService.checkin` → mỗi mission hoàn thành tăng Spendable VP.
3. Viết reward service layer (`fetchRewardCatalog`, `redeemRewardItem`, `recordDonation`, `fetchActiveLadder`) + lỗi chuyên biệt; xây API `/api/rewards/{catalog,ladders,redemptions,redeem}` và `/api/donate` (flag `TREE_ENABLED && REWARDS_ENABLED`, auth theo cookie).
4. Rewards UI: màn `/rewards` hiển thị balance + ladder + danh sách item, lịch sử redemption, nút donate (điểm/VNPay). Dashboard card chỉ mở khi `NEXT_PUBLIC_REWARDS=true`.
5. Dia Brain: emit thêm `donate` event, reuse JWT bridge helper; donation API trả payment_url dựa trên `DONATION_PORTAL_URL`.
6. Docs: cập nhật README, ENV vars, Rewards spec status; ghi chú enable flow (flags + migrations). Vitest mới `tests/rewards.catalog.spec.ts` cover eligibility + VNPay link.
7. Test suite (`npm test`) xanh; Rewards vẫn default OFF cho QA freeze.

## Pending / Follow-ups
- Apply migrations + bật `TREE_ENABLED/REWARDS_ENABLED/NEXT_PUBLIC_REWARDS` trên môi trường staging để smoke `/api/rewards/*` + `/api/donate`.
- Cung cấp `DONATION_PORTAL_URL`, `BRIDGE_URL`, `BRIDGE_KEY` thực cho QA để thấy event `donate`.
- Design cần bổ sung badge/illustration cho Rewards card khi chính thức mở; cân nhắc thêm pagination cho history trước khi lên prod.

## Issues / Risks Logged
- Caddy reverse proxy remains the public entrypoint; the staging compose stack now binds the Next.js container to `127.0.0.1:3000` only. External 80/443 continue to be served by the host-level Caddy service (PID 409705). Routing verified via curl `--resolve asinu.top:443:127.0.0.1` hitting `/api/healthz`.
- `/auth/register` stays in "MVP Freeze" state. Both email and phone flows still call Supabase `auth.signUp`, which was sunset per the Supabase retirement policy (`docs/tech/ARCHIVE_POLICY.md`). Current auth smoke instructions expect testers to reuse existing accounts and capture the `asinu.sid` cookie (`AUTH_TESTING_GUIDE.md`). No code change planned until the replacement identity path ships.

---

# Daily Report — 14.11.2025

## Scope
- Thay thế hoàn toàn Supabase Auth bằng native backend (Postgres + session nội bộ) theo AGENTS.
- Bổ sung OTP nội bộ, Google/Zalo OAuth endpoint, và cập nhật middleware/session cho bản build App Store.
- Cập nhật tài liệu/env/tests nhằm bàn giao cho QA/DevOps kích hoạt auth mới.

## Worklog
1. Viết migration `118_native_auth.sql`: mở rộng `app_user` (password_hash/algo/provider/oauth IDs), thêm `auth_session` & `auth_otp_store`, port legacy hash từ `user_settings`.
2. Tạo session store DB (`src/lib/session.ts`) và refactor `src/infrastructure/auth/session.ts` + middleware để cookie `asinu.sid` chỉ chứa UUID -> mọi GET/POST auth đều đọc từ bảng `auth_session`.
3. Thêm service layer `src/modules/auth/*` (userService, otpService, oauth state helpers) + HTTP handlers cho email/password, OTP send/verify, và OAuth.
4. Ship API tree mới: `/api/auth/email/{register,login}`, giữ `/api/auth/{register,login}` làm alias, thêm `/api/auth/phone/{send,verify}`, `/api/auth/google`, `/api/auth/zalo`, cập nhật logout/session route để xóa session DB.
5. UI giữ nguyên cấu trúc nhưng chuyển handler sang endpoint mới (`/api/auth/email/*`), đảm bảo register/login hiện vẫn password-based đúng yêu cầu.
6. Tài liệu + env: README “Native Auth” section, ENV_VARS.md, `.env.example`, `.env.production`, `env.txt` ghi SESSION/OTP/OAuth placeholders để QA biết bật; thêm Vitest mới cho user helpers, OTP service, session store.
7. Xóa `AUTH_TESTING_GUIDE.md` (đã obsolete) và cập nhật report backlog.
8. Nâng UI `/auth/login`: thêm tab OTP (gửi/nhập mã trực tiếp), trạng thái realtime, nút Google/Zalo; cập nhật logic redirect + validation để khớp session cookie.
9. Viết test RTL `__tests__/app/auth/LoginPage.test.tsx` cover flow OTP send/verify, đảm bảo mock router hoạt động; test suite `npm test` xanh (60 case).
10. Thêm script `scripts/cleanup_otp_store.ts` + npm script `otp:cleanup`, cập nhật README hướng dẫn cron/QA bật tab OTP.
11. Dựng Postgres local bằng docker compose, apply chuỗi migration `000`→`118_native_auth.sql` (tạo schema `asinu_app`, seed missions/rewards) và set `search_path` chuẩn; xác nhận `tsc --noEmit` xanh sau khi chạy.
12. Viết cron helper `ops/otp_cleanup_cron.sh` (nạp `env.txt` + `.env`, gọi `npm run otp:cleanup`) và hướng dẫn crontab (`0 * * * * ...`) trong README để QA/Ops triển khai; thêm alias `@config/*` + fix Chart.js/Tree scene typings để lint/type-check pass.
13. `npm run lint` và `npm run type-check` giờ đều xanh trở lại (lint còn cảnh báo history); `npm test` vẫn pass 60 case.

## Pending / Follow-ups
- Roll out migration `118_native_auth.sql` + ENV (`SESSION_TTL_SECONDS`, `OTP_*`, `GOOGLE_*`, `ZALO_*`) trên staging/prod, rồi smoke `/api/auth/*` (dev DB đã sync; cần chạy `ALTER DATABASE diabotdb SET search_path TO asinu_app, public;` sau migrate).
- Fix lint/type-check/build tồn đọng (ESLint rule `deprecation/deprecation`, Chart.js typings, duplicate import ở `src/app/api/relative/add/route.ts`, thiếu type cho `tree_scene.json`, v.v.) để CI xanh lại.
- Thiết lập cron job chạy `npm run otp:cleanup` (hoặc tương đương) trên môi trường thật để giữ bảng `auth_otp_store` gọn nhẹ.

### Auth Native Rollout – Staging/Prod
1. **Chuẩn bị:** xác nhận quyền Postgres, backup nhanh (`pg_dump diabotdb`), tải `.env.production` mới nhất, bảo đảm có `env.txt` nếu dùng loader.
2. **Áp migration:** `docker compose up -d asinu-postgres` (nếu cần) rồi chạy tuần tự `migrations/000_*` → `118_native_auth.sql` bằng `docker exec -i asinu-postgres psql -U postgres diabotdb < migrations/XXX.sql`.
3. **Fix search_path:** `ALTER DATABASE diabotdb SET search_path TO asinu_app, public;`.
4. **ENV staging/prod:** set `SESSION_TTL_SECONDS=86400`, `OTP_TTL_SECONDS=300`, `OTP_STATIC_VALUE=<prod-value>`, `GOOGLE_*`, `ZALO_*`, rồi restart app/container.
5. **Smoke auth:** curl/HTTP test `POST /api/auth/email/register`, `POST /api/auth/email/login`, `POST /api/auth/phone/{send,verify}`, `GET /api/auth/{google,zalo}`, `POST /api/auth/logout`.
6. **Cron cleanup:** copy `ops/otp_cleanup_cron.sh` to `/opt/asinu`, `chmod +x`, add `0 * * * * /opt/asinu/ops/otp_cleanup_cron.sh >> /var/log/asinu/otp_cleanup.log 2>&1`, and run once manually to confirm logs.
7. **Verification:** ensure UI login (password/OTP/OAuth) works, OTP table only has fresh rows, logs clean (no 500s), and CI build stays lint/type clean.
## Issues / Risks Logged
- `npm run lint` hiện fail do rule `deprecation/deprecation` không tồn tại (từ trước) → cần dọn eslint config để unblock pipeline.
- `npm run type-check` vẫn fail do lỗi cũ (Chart.js generics, `NextResponse` double import, `PoolClient` import ở rewards, thiếu type asset Life Tree). Không phải regression từ auth nhưng phải xử lý để build được.
- `npm run build` kẹt khi Next tải Google Fonts (DNS `fonts.googleapis.com` trong sandbox) và các lỗi type bên trên → cần rerun khi network cho phép + đã sửa type.
- OAuth endpoint dùng placeholder env; nếu triển khai mà không có secret hợp lệ sẽ trả lỗi cấu hình. Cần khóa cờ trước khi expose publicly.

ğŸ§± Má»¤C TIÃŠU GIáº¢I PHÃP CUá»I

KhÃ´ng bao giá» cÃ²n lá»—i Jimp / buffer null / unexpected end of stream khi build.

Build dev / build tháº­t Ä‘á»u cháº¡y trÃªn mÃ´i trÆ°á»ng chuáº©n (WSL + adb).

CÃ³ QC táº§ng há»‡ thá»‘ng: sai mÃ´i trÆ°á»ng, sai cáº¥u trÃºc, sai asset lÃ  bá»‹ cháº·n sá»›m, khÃ´ng Ä‘áº¿n tay mÃ y.

Giáº£i phÃ¡p gá»“m 3 táº§ng:

Táº§ng A: KhÃ³a mÃ´i trÆ°á»ng & máº¡ng (theo chuyÃªn gia 2).

Táº§ng B: KhÃ³a cáº¥u hÃ¬nh app + asset theo â€œkhÃ´ng cho Expo tá»± resize ná»¯aâ€ (theo chuyÃªn gia 1).

Táº§ng C: QC & CI Ä‘á»ƒ khÃ´ng ai phÃ¡ Ä‘Æ°á»£c.

ğŸ…° Táº¦NG A â€“ KHÃ“A MÃ”I TRÆ¯á»œNG & Máº NG
A1. Quy táº¯c vÃ ng mÃ´i trÆ°á»ng (báº¯t buá»™c team tuÃ¢n thá»§)

Project React Native/Expo chá»‰ Ä‘Æ°á»£c phÃ©p Ä‘áº·t á»Ÿ:

~/asinu
~/projects/asinu-lite


Cáº¤M HOÃ€N TOÃ€N:

C:\...

/mnt/c/...

/mnt/f/...

Quy Æ°á»›c cho cáº£ team:

â€œTháº¥y /mnt/* lÃ  khÃ´ng cháº¡y npm / expo. Chá»‰ Ä‘Æ°á»£c ~/.â€

A2. Quy táº¯c máº¡ng dev-client

Má»™t pack duy nháº¥t:

# 1) WSL â€“ start Metro
cd ~/asinu/apps/asinu-lite
EXPO_NO_ADB=1 npx expo start --dev-client --clear --host localhost

# 2) Windows â€“ ná»‘i emulator vá»›i Metro
adb devices
adb reverse tcp:8081 tcp:8081
adb shell am start -a android.intent.action.VIEW -d "asinu-lite://expo-development-client/?url=http%3A%2F%2F127.0.0.1%3A8081"


â†’ Tá»« giá», dev-client luÃ´n connect Ä‘Æ°á»£c, khÃ´ng ai pháº£i báº¥m loáº¡n tay trong UI ná»¯a.

ğŸ…± Táº¦NG B â€“ KHÃ“A Cáº¤U HÃŒNH APP + ASSET (GIáº¢I PHÃP CHá»T)

Má»¥c tiÃªu táº§ng nÃ y:

â€œCáº¯t Ä‘á»©t hoÃ n toÃ n Ä‘Æ°á»ng Jimp/@expo/image-utils áº£nh hÆ°á»Ÿng Ä‘áº¿n build tháº­t.â€

Tá»©c lÃ :

Expo khÃ´ng cÃ²n pháº£i tá»± resize icon/splash cho production ná»¯a.

MÃ¬nh tá»± chuáº©n bá»‹ full bá»™ icon native cho iOS & Android, giá»‘ng cÃ¡ch cÃ¡c app lá»›n lÃ m.

B1. app.config â€“ báº£n chá»‘t production

Táº¡o file app.config.js á»Ÿ gá»‘c repo (hoáº·c app.config.ts náº¿u mÃ y thÃ­ch TS):

// app.config.js â€“ cáº¥u hÃ¬nh CHá»T cho asinu-lite
const IS_DEV = process.env.APP_ENV === "development";

export default {
  name: "Asinu",
  slug: "asinu-lite",
  version: "1.0.0",
  orientation: "portrait",
  userInterfaceStyle: "automatic",

  // DÃ¹ng cho DEV lÃ  chÃ­nh (dev-client nhÃ¬n cho Ä‘á»¡ xáº¥u)
  icon: "./assets/icon.png",
  splash: {
    image: "./assets/splash.png",
    resizeMode: "contain",
    backgroundColor: "#000000",
  },

  ios: {
    bundleIdentifier: "com.asinu.lite",
    supportsTablet: true,
    // ToÃ n bá»™ icon iOS láº¥y tá»« AppIcon.appiconset â€“ KHÃ”NG Äá»‚ EXPO Tá»° RESIZE
    icon: "./assets/ios/AppIcon.appiconset",
  },

  android: {
    package: "com.asinu.lite",
    // ToÃ n bá»™ icon Android láº¥y tá»« mipmap â€“ KHÃ”NG Äá»‚ EXPO Tá»° RESIZE
    icon: "./assets/android/mipmap",
    adaptiveIcon: {
      foregroundImage: "./assets/android/adaptive-foreground.png",
      backgroundImage: "./assets/android/adaptive-background.png",
    },
  },

  plugins: [
    "expo-router",
    // Chá»‘t: khÃ´ng dÃ¹ng tÃ­nh nÄƒng resize tá»± Ä‘á»™ng cá»§a image-utils trong pipeline
    ["@expo/image-utils", { useSharp: false }],
  ],

  extra: {
    eas: {
      projectId: "ÄIá»€N_PROJECT_ID_THáº¬T_VÃ€O_ÄÃ‚Y",
    },
    appEnv: process.env.APP_ENV ?? "development",
  },

  updates: {
    fallbackToCacheTimeout: 0,
  },

  assetBundlePatterns: ["**/*"],
};


Ã Ä‘á»“:
â€“ icon / splash á»Ÿ trÃªn chá»§ yáº¿u phá»¥c vá»¥ dev-client + Expo Go.
â€“ Build tháº­t láº¥y icon tá»« thÆ° má»¥c native (AppIcon.appiconset, mipmap), khÃ´ng Ã©p Expo/Jimp resize ná»¯a.

B2. Cáº¥u trÃºc thÆ° má»¥c assets CHUáº¨N

Chuáº©n hoÃ¡ assets/ nhÆ° sau:

assets/
â”œâ”€â”€ icon.png                      # 1024x1024 â€“ dev-only
â”œâ”€â”€ splash.png                    # 2048x2048 â€“ dev-only
â”œâ”€â”€ ios/
â”‚   â””â”€â”€ AppIcon.appiconset/       # 20+ file icon iOS (16, 20, 29, 40, 60, 76, 83.5, 1024â€¦)
â””â”€â”€ android/
    â”œâ”€â”€ mipmap-hdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-mdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xhdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xxhdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xxxhdpi/ic_launcher.png
    â”œâ”€â”€ adaptive-foreground.png
    â””â”€â”€ adaptive-background.png


Má»™t láº§n lÃ m cho xong:

Láº¥y 1 file icon-source.png 1024x1024 (Asinu logo).

DÃ¹ng tool (appicon.co hoáº·c script ná»™i bá»™) generate:

Bá»™ AppIcon.appiconset cho iOS.

Bá»™ mipmap-* + adaptive cho Android.

Bá» toÃ n bá»™ file icon cÅ© khÃ´ng rÃµ nguá»“n gá»‘c; khÃ´ng dÃ¹ng file nÃ o Ä‘Ã£ tá»«ng copy tá»« /mnt/f.

LÃ m xong bÆ°á»›c nÃ y â†’ build tháº­t khÃ´ng cáº§n Jimp resize icon ná»¯a.

ğŸ…² Táº¦NG C â€“ QC & PHÃ’NG NGá»ªA (CHO TÆ¯Æ NG LAI)
C1. Pre-commit check asset

ThÃªm 1 script Node hoáº·c bash Ä‘Æ¡n giáº£n:

Tá»« assets/:

Kiá»ƒm tra file 0 byte â†’ cháº·n commit.

Kiá»ƒm tra chá»‰ nháº­n .png / .jpg cho icon/splash.

NhÃºng qua Husky, vÃ­ dá»¥:

// package.json
"scripts": {
  "lint:assets": "node scripts/check-assets.js"
},
"husky": {
  "hooks": {
    "pre-commit": "npm run lint:assets"
  }
}


Ã nghÄ©a:

Dev nÃ o commit file áº£nh bá»‹ lá»—i â†’ bá»‹ cháº·n tá»« sá»›m, khÃ´ng bao giá» lÃªn tá»›i stage build.

C2. QC expo-router entry

ThÃªm 1 test nhá» (cÃ³ thá»ƒ lÃ  jest / script):

Kiá»ƒm tra tá»“n táº¡i apps/asinu-lite/index.js

BÃªn trong cÃ³ import 'expo-router/entry';

Náº¿u khÃ´ng â†’ CI fail.

C3. CI build hÃ ng ngÃ y (hoáº·c má»—i láº§n merge vÃ o nhÃ¡nh chÃ­nh)

GitHub Actions / GitLab CI:

Job WSL / Linux fresh.

npm ci

eas build --profile preview --platform android --non-interactive

Má»¥c tiÃªu:
â€“ Náº¿u cÃ³ lá»—i asset / config â†’ nÃ³ ná»• trÃªn CI, khÃ´ng ná»• trÃªn mÃ¡y mÃ y lÃºc chuáº©n bá»‹ submit Store.

ğŸ“Œ TÃ“M Láº I â€“ GIáº¢I PHÃP CUá»I

KhÃ³a mÃ´i trÆ°á»ng: chá»‰ WSL ~/asinu, adb reverse pack cá»‘ Ä‘á»‹nh.

KhÃ³a cáº¥u hÃ¬nh app: dÃ¹ng app.config.js nhÆ° trÃªn + full bá»™ icon native iOS/Android â†’ Expo khÃ´ng cÃ²n pháº£i tá»± resize icon/splash á»Ÿ build tháº­t ná»¯a.

KhÃ³a QC: pre-commit check asset, kiá»ƒm tra expo-router entry, CI build preview.

ğŸ‘‰ LÃ m xong 3 táº§ng nÃ y:

Lá»—i Jimp / buffer null / unexpected end of stream / Metro crash vÃ¬ asset:
= 0% kháº£ nÄƒng láº·p láº¡i trong build tháº­t.

Build dev-client, build preview, build production: táº¥t cáº£ Ä‘i chung má»™t Ä‘Æ°á»ng, dá»… kiá»ƒm soÃ¡t.

MÃ y duyá»‡t xong giáº£i phÃ¡p nÃ y, tao sáº½ bÆ°á»›c tiáº¿p sang báº£n thá»±c thi cá»¥ thá»ƒ cho repo asinu-lite:
â€“ viáº¿t app.config.js Ä‘Ãºng vá»›i cÃ¢y thÆ° má»¥c hiá»‡n táº¡i,
â€“ liá»‡t kÃª rÃµ icon nÃ o cáº§n mÃ y gá»­i designer váº½ láº¡i,
â€“ vÃ  (náº¿u muá»‘n) táº¡o luÃ´n skeleton scripts/check-assets.js cho QC.

Báº¡n Ä‘Ã£ nÃ³i:
cHá»T Láº¬P FILE .md tao gá»­i codex nÃ³ lÃ m
ChatGPT Ä‘Ã£ nÃ³i:

DÆ°á»›i Ä‘Ã¢y lÃ  file .md CHUáº¨N â€“ HOÃ€N CHá»ˆNH â€“ RÃ• RÃ€NG Ä‘á»ƒ mÃ y gá»­i tháº³ng cho Codex thá»±c hiá»‡n.
KhÃ´ng dÃ i dÃ²ng, khÃ´ng triáº¿t lÃ½, chá»‰ toÃ n yÃªu cáº§u ká»¹ thuáº­t báº¯t buá»™c + hÃ nh Ä‘á»™ng cá»¥ thá»ƒ.

ğŸ“˜ ASINU-LITE_BUILD_FIX_2025.md
Giáº£i phÃ¡p cuá»‘i cÃ¹ng Ä‘á»ƒ loáº¡i bá» hoÃ n toÃ n lá»—i Jimp / Metro crash / unexpected end of stream

NgÃ y Ã¡p dá»¥ng: 04/12/2025
NgÆ°á»i thá»±c thi: Codex
Má»¥c tiÃªu:

Äáº£m báº£o build dev-client, preview, production khÃ´ng bao giá» vá»¡ tráº­n ná»¯a.

Loáº¡i bá» 100% nguyÃªn nhÃ¢n gÃ¢y lá»—i Jimp (Could not find MIME for Buffer <null>).

Chuáº©n hÃ³a cáº¥u hÃ¬nh project vÃ  assets theo tiÃªu chuáº©n 2025.

I. ğŸ§± Táº¦NG A â€“ KhÃ³a MÃ´i TrÆ°á»ng & Máº¡ng
1. Cháº¡y project chá»‰ trong WSL filesystem

Báº¯t buá»™c:

Dá»± Ã¡n Ä‘áº·t táº¡i:

~/asinu/apps/asinu-lite


KhÃ´ng Ä‘Æ°á»£c Ä‘áº·t hoáº·c cháº¡y lá»‡nh npm/expo trong:

C:\...
/mnt/c/...
/mnt/f/...

2. Pack máº¡ng chuáº©n cho dev-client

Táº¡o file shell script dev.sh á»Ÿ root project:

#!/bin/bash
cd ~/asinu/apps/asinu-lite
EXPO_NO_ADB=1 npx expo start --dev-client --clear --host localhost


VÃ  Windows script dev-connect.ps1:

adb reverse tcp:8081 tcp:8081
adb shell am start -a android.intent.action.VIEW -d "asinu-lite://expo-development-client/?url=http%3A%2F%2F127.0.0.1%3A8081"


Tá»« Ä‘Ã¢y táº¥t cáº£ dev pháº£i dÃ¹ng Ä‘Ãºng 2 script nÃ y.

II. ğŸ§± Táº¦NG B â€“ KhÃ³a Cáº¥u HÃ¬nh App (app.config.js)

Táº¡o file app.config.js táº¡i root (hoáº·c ghi Ä‘Ã¨ file cÅ©):

// app.config.js â€“ cáº¥u hÃ¬nh CHá»T Ä‘á»ƒ build production khÃ´ng bao giá» crash
export default {
  name: "Asinu",
  slug: "asinu-lite",
  version: "1.0.0",
  orientation: "portrait",
  userInterfaceStyle: "automatic",

  // Icon & splash chá»‰ phá»¥c vá»¥ DEV, build production dÃ¹ng icon native
  icon: "./assets/icon.png",
  splash: {
    image: "./assets/splash.png",
    resizeMode: "contain",
    backgroundColor: "#000000",
  },

  ios: {
    bundleIdentifier: "com.asinu.lite",
    supportsTablet: true,
    icon: "./assets/ios/AppIcon.appiconset",
  },

  android: {
    package: "com.asinu.lite",
    adaptiveIcon: {
      foregroundImage: "./assets/android/adaptive-foreground.png",
      backgroundImage: "./assets/android/adaptive-background.png",
    },
    icon: "./assets/android/mipmap",
  },

  plugins: [
    "expo-router",
    ["@expo/image-utils", { useSharp: false }],
  ],

  extra: {
    eas: {
      projectId: "ÄIá»€N_PROJECT_ID_VÃ€O_ÄÃ‚Y",
    },
  },

  updates: { fallbackToCacheTimeout: 0 },
  assetBundlePatterns: ["**/*"],
};


Má»¥c tiÃªu: Táº¯t hoÃ n toÃ n viá»‡c Expo tá»± resize icon/splash khi build.

III. ğŸ§± Táº¦NG C â€“ Chuáº©n hÃ³a thÆ° má»¥c assets

Codex cáº§n táº¡o Ä‘Ãºng cáº¥u trÃºc sau:

assets/
â”œâ”€â”€ icon.png                      # 1024x1024 (dev)
â”œâ”€â”€ splash.png                    # 2048x2048 (dev)
â”œâ”€â”€ ios/
â”‚   â””â”€â”€ AppIcon.appiconset/       # chá»©a 20+ file icon iOS gá»‘c
â””â”€â”€ android/
    â”œâ”€â”€ mipmap-mdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-hdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xhdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xxhdpi/ic_launcher.png
    â”œâ”€â”€ mipmap-xxxhdpi/ic_launcher.png
    â”œâ”€â”€ adaptive-foreground.png
    â””â”€â”€ adaptive-background.png


Codex khÃ´ng Ä‘Æ°á»£c tá»± cháº¿ áº£nh.
Designer sáº½ cung cáº¥p icon-source.png 1024Ã—1024.

IV. ğŸ§ª Táº¦NG D â€“ QC Kiá»ƒm tra Asset (Pre-commit Hook)

Táº¡o script scripts/check-assets.js:

const fs = require("fs");
const path = require("path");

const checkPaths = [
  "assets/icon.png",
  "assets/splash.png",
  "assets/ios/AppIcon.appiconset",
  "assets/android/mipmap",
];

function checkFile(file) {
  if (!fs.existsSync(file)) {
    console.error("[ASSET ERROR] Missing file:", file);
    process.exit(1);
  }
  const stat = fs.statSync(file);
  if (stat.size === 0) {
    console.error("[ASSET ERROR] Empty file:", file);
    process.exit(1);
  }
}

function walk(dir) {
  fs.readdirSync(dir).forEach((file) => {
    const p = path.join(dir, file);
    if (fs.statSync(p).isDirectory()) walk(p);
    else checkFile(p);
  });
}

checkPaths.forEach((p) => {
  const full = path.resolve(p);
  if (fs.existsSync(full) && fs.statSync(full).isDirectory()) walk(full);
  else checkFile(full);
});

console.log("[ASSET CHECK] OK");


ThÃªm vÃ o package.json:

"scripts": {
  "lint:assets": "node scripts/check-assets.js"
},
"husky": {
  "hooks": {
    "pre-commit": "npm run lint:assets"
  }
}


â†’ Dev commit file áº£nh lá»—i â†’ bá»‹ cháº·n ngay, khÃ´ng lá»t vÃ o repo.

V. âš™ï¸ Táº¦NG E â€“ CI Build HÃ ng NgÃ y

Táº¡o workflow GitHub Actions .github/workflows/daily-build.yml:

name: Daily Build Check

on:
  schedule:
    - cron: "0 18 * * *"   # build má»—i ngÃ y 1 láº§n (18h VN)
  workflow_dispatch: {}

jobs:
  build-preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: EAS build preview
        run: |
          npm install -g eas-cli
          eas build --platform android --profile preview --non-interactive


â†’ Náº¿u icon/splash há»ng â†’ CI ná»• ngay â†’ khÃ´ng bao giá» lÃªn tay Founder.

VI. âœ” Checklist thá»±c hiá»‡n cho Codex

Táº¡o file app.config.js theo máº«u.

Táº¡o láº¡i folder assets/ Ä‘Ãºng cáº¥u trÃºc.

ThÃªm script QC asset + pre-commit hook.

Táº¡o workflow daily build.

XÃ³a toÃ n bá»™ asset cÅ© lá»—i thá»i, file há»ng.

Commit theo Ä‘Ãºng tiÃªu chuáº©n.

VII. ğŸ¯ Káº¿t luáº­n

Sau khi Codex thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ file nÃ y:

Build dev-client: Ok 100%

Build EAS preview: Ok 100%

Build EAS production (AAB/IPA): Ok 100%

KhÃ´ng cÃ²n:

âŒ Jimp crash

âŒ Buffer null

âŒ unexpected end of stream

âŒ Metro cháº¿t giá»¯a chá»«ng

Asinu Lite Ä‘Æ°á»£c Ä‘Æ°a vÃ o tráº¡ng thÃ¡i build á»•n Ä‘á»‹nh dÃ i háº¡n 2025â€“2030.